<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nairobi_cherangany-navigation-map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; }

    /* Collapsible floating panel */
    #routing-container {
        position: fixed;
        bottom: 10px;
        left: 10px;
        right: 10px;
        max-height: 65%;
        overflow: hidden;
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        transition: max-height 0.3s ease;
        z-index: 1000;
        font-family: sans-serif;
    }
    #routing-container.collapsed { max-height: 40px; }
    #routing-panel { padding: 10px; }
    #toggle-routing {
        width: 100%;
        background: #d495a5;
        border: none;
        color: white;
        font-weight: 600;
        padding: 10px;
        border-radius: 12px 12px 0 0;
        cursor: pointer;
    }
    #toggle-routing:hover { background: #c87c91; }
    #controls { margin-top: 5px; display:flex; gap:5px; flex-wrap:wrap; }
    #controls button { flex: 1; padding: 5px; border-radius:6px; border:none; background:#f1c0c0; cursor:pointer; }
    #controls button:hover { background:#e5a2a2; }
</style>
</head>
<body>

<div id="map"></div>

<div id="routing-container" class="collapsed">
    <button id="toggle-routing">üó∫Ô∏è Show / Hide Navigation</button>
    <div id="routing-panel">
        <div id="controls">
            <button id="fastestBtn">Fastest Route</button>
            <button id="shortestBtn">Shortest Route</button>
            <button id="clearRouteBtn">Clear Route</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
// Nairobi start point
const NAIROBI_START = L.latLng(-1.28333, 36.8167);
const nurseryWaypoints = [];

// Initialize map
var map = L.map('map').setView([0.5, 35.5], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// GeoJSON files
var geojsonFiles = [
    {file: 'cherangany_fblock_wgs84.json', style:{color:'green', weight:3, fillOpacity:0.2}, name:'Cherangany Forest Block', type:'polygon'},
    {file: 'elgeyo_marakwet_county.json', style:{color:'blue', weight:2}, name:'Elgeyo Marakwet Nurseries', type:'point'},
    {file: 'west_pokot_county.json', style:{color:'orange', weight:2}, name:'West Pokot Nurseries', type:'point'}
];

const loadPromises = [];

geojsonFiles.forEach(item => {
    const promise = fetch(item.file)
        .then(res => res.json())
        .then(data => {
            L.geoJSON(data, {
                style: item.style,
                pointToLayer: function(feature, latlng){
                    if(item.type === 'point'){
                        nurseryWaypoints.push(latlng);
                        return L.marker(latlng);
                    }
                    return null;
                },
                onEachFeature: function(feature, layer){
                    let popup = "<strong>" + item.name + "</strong>";
                    if(feature.properties && feature.properties.name) popup += "<br>" + feature.properties.name;
                    layer.bindPopup(popup);
                }
            }).addTo(map);
        });
    loadPromises.push(promise);
});

let routingControl = null;

function createRoute(profile='fastest'){
    if(routingControl) map.removeControl(routingControl);

    const finalWaypoints = [
        L.Routing.waypoint(NAIROBI_START, 'Nairobi (Start)'),
        ...nurseryWaypoints,
        L.Routing.waypoint(nurseryWaypoints[nurseryWaypoints.length-1], 'Final Nursery')
    ];

    routingControl = L.Routing.control({
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: profile }),
        waypoints: finalWaypoints,
        routeWhileDragging: false,
        show: true,
        language: 'en',
        lineOptions: { styles: [{color:'#D495A5', weight:6, opacity:0.8}] }
    }).addTo(map);

    document.getElementById('routing-panel').appendChild(routingControl.getContainer());
    map.setZoom(7);
}

Promise.all(loadPromises).then(() => {
    createRoute('fastest');
});

// Collapsible panel
document.getElementById('toggle-routing').addEventListener('click', ()=>{
    document.getElementById('routing-container').classList.toggle('collapsed');
});

// Buttons
document.getElementById('fastestBtn').addEventListener('click', ()=> createRoute('fastest'));
document.getElementById('shortestBtn').addEventListener('click', ()=> createRoute('shortest'));
document.getElementById('clearRouteBtn').addEventListener('click', ()=>{
    if(routingControl) map.removeControl(routingControl);
    routingControl = null;
});

</script>
</body>
</html>
